# ä½¿ç”¨vr-panoramaç”Ÿæˆä¸€ä¸ªvrå…¨æ™¯æ¼«æ¸¸ç³»ç»Ÿ(äºŒ)

## å‰è¨€

æ¥ç€ä¸Šä¸€ç¯‡[ä½¿ç”¨vr-panoramaç”Ÿæˆä¸€ä¸ªvrå…¨æ™¯æ¼«æ¸¸ç³»ç»Ÿ(ä¸€)]()ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦ä»‹ç»vr-panoramaé¡¹ç›®ä¸­åŠ¨æ€åŠ è½½åˆ‡ç‰‡å›¾çš„å®ç°ã€‚

å°†ä¸€å¼ å…¨æ™¯å›¾è´´åœ¨çƒé¢ä¸Šæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ï¼Œåªè¦åœ¨çƒé¢ä¸Šä½¿ç”¨å…¨æ™¯å›¾ä½œä¸ºçº¹ç†å°±å¯ä»¥äº†ï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œä¸€å¼ æ¸…æ™°çš„å…¨æ™¯å›¾å°ºå¯¸éƒ½å¾ˆå¤§ï¼Œå¦‚æœç›´æ¥æ˜¾ç¤ºæ•´ä¸ªè´´åˆ°çƒé¢ä¸Šï¼Œç”¨æˆ·å¯èƒ½ä¼šç­‰å¾…å¾ˆé•¿ä¸€æ®µæ—¶é—´æ‰èƒ½çœ‹åˆ°æ¸²æŸ“æ•ˆæœï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ä½“éªŒå¾ˆä¸å‹å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°å…¨æ™¯å›¾çš„æŒ‰éœ€åŠ è½½ï¼Œæˆ‘ä»¬é¦–å…ˆå°†å…¨æ™¯å›¾å‹ç¼©åˆ°ä¸€ä¸ªä½“ç§¯æ¯”è¾ƒå°çš„å°ºå¯¸ï¼Œç„¶åå…ˆæ¸²æŸ“åˆ°çƒé¢ä¸Šï¼Œç„¶åå½“ç”¨æˆ·æ‹–åŠ¨å…¨æ™¯å›¾çš„æ—¶å€™æˆ‘ä»¬é€šè¿‡è®¡ç®—å¾—åˆ°åº”è¯¥æ¸²æŸ“çš„ç¢ç‰‡å›¾ï¼Œç„¶åæŠŠè¿™äº›æ¸…æ™°çš„ç¢ç‰‡å›¾åŠ è½½åˆ°é¡µé¢ä¸Šã€‚

ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

- å¦‚ä½•åœ¨çƒé¢ä¸Šæ¸²æŸ“å¤šå¼ çº¹ç†å›¾ç‰‡
- å¦‚ä½•å°†ç¢ç‰‡å›¾æ¸²æŸ“åˆ°å®ƒåº”è¯¥å‡ºç°çš„ä½ç½®ä¸Š
- å¦‚ä½•åˆ¤æ–­å½“å‰è§†é‡å†…åº”è¯¥åŠ è½½å“ªäº›ç¢ç‰‡å›¾

## å¦‚ä½•åœ¨çƒé¢ä¸Šæ¸²æŸ“å¤šå¼ å…¨æ™¯å›¾

é¦–å…ˆæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ä¸‰è§’é¢çš„æ¦‚å¿µï¼Œåœ¨threejsæ¨¡å‹ä¸­ï¼Œæ— è®ºæ˜¯æ­£æ–¹ä½“è¿˜æ˜¯çƒä½“æˆ–è€…å¤šé¢ä½“ï¼Œç»„æˆä»–ä»¬åŸºæœ¬çš„å•ä½éƒ½æ˜¯ä¸‰è§’å½¢ï¼Œæ­£æ–¹ä½“ä¸­ï¼Œæ¯ä¸€ä¸ªé¢éƒ½æ˜¯ç”±ä¸¤ä¸ªä¸‰è§’å½¢ç»„åˆå®Œæˆçš„ï¼Œåœ¨çƒä½“ä¸­ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªä¸ªä¸‰è§’å½¢ç»„åˆå®Œæˆçš„ã€‚æˆ‘ä»¬å°±ç§°è¿™æ¯ä¸€ä¸ªä¸‰è§’å½¢ä¸ºä¸‰è§’é¢ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æ¯ä¸€ä¸ªä¸‰è§’é¢ã€‚ä»¥çƒä½“ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä½¿ç”¨threeç”Ÿæˆçƒä½“å¯¹è±¡çš„æ—¶å€™ï¼Œéœ€è¦åˆ¶å®šæ¨ªå‘åˆ‡å‰²æ•°å’Œçºµå‘åˆ‡å‰²æ•°ï¼Œå½“æˆ‘ä»¬çš„æ¨ªå‘åˆ‡å‰²å’Œçºµå‘åˆ‡å‰²çš„å€¼è¶Šå¤§ï¼Œç”Ÿæˆçš„ä¸‰è§’é¢ä¹Ÿå°±è¶Šå¤šï¼Œæ‰€ç”Ÿæˆçš„`çƒä½“`ä¹Ÿå°±è¶Šåƒä¸€ä¸ªçœŸæ­£çš„çƒä½“ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¹ç†è´´å›¾çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æŠŠå›¾ç‰‡çº¹ç†æ¸²æŸ“åˆ°æ¯ä¸€ä¸ªä¸‰è§’é¢ä¸Šï¼Œç„¶åç»„åˆæˆäº†å®Œæˆçš„å›¾ç‰‡ã€‚

æ‰€ä»¥ï¼Œæƒ³è¦åœ¨çƒé¢ä¸Šæ¸²æŸ“å¤šå¼ å…¨æ™¯å›¾ï¼Œæˆ‘ä»¬å°±éœ€è¦è®©æ¯ä¸€ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸åŒçš„å›¾ç‰‡ä½œä¸ºæ¸²æŸ“æºã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠè¦æ¸²æŸ“çš„ç¢ç‰‡å›¾æ·»åŠ åˆ°materialsæ•°ç»„ä¸­ï¼š

```js
// glPainter.js
// åŠ è½½æ¸…æ™°å›¾
  loadSlices() {
    // åˆ¤æ–­å¦‚æœå…¨éƒ¨çš„ç¢ç‰‡å›¾éƒ½åŠ è½½è¿‡ä¸€æ¬¡å°±ä¸å†åŠ è½½
    if(this.complate) return;
    const urls = this.slices;
    const camera = this.viewer.camera;
    if(!urls) return;
    const row = urls.length;
    const col = urls[0].length;
    // æ¸²æŸ“
    for(let i = 0; i < row; i++) {
      for(let j = 0; j < col; j++) {
        const index = i * col + j + 1;
          if(!this.sliceMap[`${i}-${j}`]) {
            const isInSight = utils.isInSight(i, j, camera);
            if(isInSight) {
              this.drawSlice(index, urls[i][j]);
              this.sliceMap[`${i}-${j}`] = 1;
              this.complate = this.checkComplate();
            }
          }
      }
    }
  }
```

è¿™é‡Œæˆ‘ä»¬é€šè¿‡è¯»å–æ•°æ®ä¸­çš„slicesæ•°ç»„ï¼Œç„¶ååˆ¤æ–­ç¢ç‰‡å›¾æ˜¯å¦åœ¨å½“å‰è§†é‡(è¿™ä¸ªåˆ¤æ–­å‡½æ•°æˆ‘ä»¬åé¢å†è¯¦ç»†è¯´)ï¼Œå¦‚æœåœ¨çš„è¯æˆ‘ä»¬å°±å»åŠ è½½è¿™ä¸ªå›¾ç‰‡ï¼Œå¹¶æ·»åŠ åˆ°materialsæ•°ç»„ä¸­ï¼š

```js
// glpainter.js
  // è®¾ç½®ææ–™æ•°ç»„
  drawSlice(index, url) {
    let loader = new TextureLoader();
    loader.format = RGBFormat;
    loader.crossOrigin = '*';
    // ä½¿ç”¨å…¨æ™¯å›¾ç‰‡ç”Ÿæˆçº¹ç†
    loader.load(url, (texture) => {
      // è¿™é‡Œå¯ä»¥è®©çº¹ç†ä¹‹é—´çš„è¿‡æ¸¡æ›´åŠ è‡ªç„¶ï¼Œä¸ä¼šå‡ºç°æ˜æ˜¾çš„æ£±è§’
      texture.minFilter=LinearFilter;
      texture.magFilter=LinearFilter;
      this.sphere.material[index] = new MeshBasicMaterial({
        map: texture
      });
      this.updateSliceView(index);
    });
  }
```

ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŒ‡å®šæ¯ä¸€ä¸ªä¸‰è§’é¢ä½¿ç”¨å®ƒå¯¹åº”çš„ææ–™ä½œä¸ºçº¹ç†ï¼š

```js
  // æ›´æ–°ä¸‰è§’é¢uvæ˜ å°„
  updateSliceView(index) {
    let sliceIndex = 0;
    const {widthSegments, heightSegments, widthScale, heightScale} = this;
    for (let i = 0, l = this.sphere.geometry.faces.length; i < l; i++) {
      // æ¯ä¸€ä¸ªä¸‰è§’é¢å¯¹åº”çš„å›¾ç‰‡ç´¢å¼•
      const imgIndex = utils.transIndex(i, widthSegments, heightSegments, widthScale, heightScale);
      if(imgIndex === index) {
        sliceIndex++;
        const uvs = utils.getVertexUvs(sliceIndex, widthScale, heightScale);
        if(i >= widthSegments*2*heightSegments - 3*widthSegments || i < widthSegments) {
          this.sphere.geometry.faces[i].materialIndex = index;
          this.sphere.geometry.faceVertexUvs[0][i][0].set(...uvs[0].a);
          this.sphere.geometry.faceVertexUvs[0][i][1].set(...uvs[0].b);
          this.sphere.geometry.faceVertexUvs[0][i][2].set(...uvs[0].c);
        }else {
          this.sphere.geometry.faces[i].materialIndex = index;
          this.sphere.geometry.faces[i+1].materialIndex = index;
          this.sphere.geometry.faceVertexUvs[0][i][0].set(...uvs[0].a);
          this.sphere.geometry.faceVertexUvs[0][i][1].set(...uvs[0].b);
          this.sphere.geometry.faceVertexUvs[0][i][2].set(...uvs[0].c);
          this.sphere.geometry.faceVertexUvs[0][i+1][0].set(...uvs[1].a);
          this.sphere.geometry.faceVertexUvs[0][i+1][1].set(...uvs[1].b);
          this.sphere.geometry.faceVertexUvs[0][i+1][2].set(...uvs[1].c);
          i++;
        }
      }
    }
  }
```

æ¯ä¸€ä¸ªä¸‰è§’é¢æœ‰ä¸€ä¸ªmaterialIndexå±æ€§ï¼Œå®ƒä¼šè‡ªåŠ¨è¯»å–materialså¯¹è±¡ä¸­çš„æŒ‡å®šindexä½œä¸ºå½“å‰ä¸‰è§’é¢çš„æ¸²æŸ“æºã€‚

è¿™é‡Œå¤§å®¶å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬çš„çƒé¢è¢«æ¨ªå‘åˆ‡æˆäº†å¾ˆå¤šä»½ï¼Œçºµå‘ä¹Ÿè¢«åˆ‡å‰²æˆäº†å¾ˆå¤šä»½ï¼Œè€Œæˆ‘ä»¬çš„å…¨æ™¯å›¾ç¢ç‰‡æ˜¯æŒ‰ç…§8*4åˆ‡å‰²çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„materialsæ•°ç»„æœ€å¤šä¹Ÿå°±32å¼ å›¾ç‰‡ï¼Œæ€ä¹ˆçŸ¥é“æ¯ä¸€ä¸ªä¸‰è§’é¢åº”è¯¥ä½¿ç”¨å“ªå¼ å›¾ç‰‡ä½œä¸ºå½“å‰ä¸‰è§’é¢çš„materialå‘¢ï¼Ÿ

å…¶å®è¿™ä¸ªæ˜¯å¯ä»¥é€šè¿‡è®¡ç®—æ¥å¾—åˆ°çš„ï¼Œæˆ‘å†™äº†ä¸€ä¸ªtransIndexå‡½æ•°æ¥å®Œæˆè¿™ä¸ªè®¡ç®—ï¼Œåœ¨çœ‹è¿™ä¸ªå‡½æ•°ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€å¼ å›¾ï¼š
![çƒä½“çš„ä¸‰è§’é¢](../../_media/three/sphere.png)

è¿™æ˜¯ä¸€ä¸ªæ¨ªå‘åˆ‡å‰²æ•°ä¸º12ï¼Œçºµå‘åˆ‡å‰²æ•°ä¸º6çš„çƒä½“çš„ä¸‰è§’é¢æ„æˆã€‚å®ƒçš„ä¸‰è§’é¢æ€»æ•°ä¸º120ï¼Œå…¶ä¸­é¡¶éƒ¨å’Œåº•éƒ¨çš„ä¸‰è§’é¢æ•°é‡æ˜¯12ï¼Œä¸­é—´çš„æ¯ä¸€è¡Œä¸‰è§’é¢æ•°é‡æ˜¯24ã€‚ç„¶åæˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªå‡½æ•°ï¼Œåº”è¯¥èƒ½æ›´å¥½ç†è§£ï¼š

```js
 /**
  * @description è¿™ä¸ªå‡½æ•°ç”¨æ¥è®¡ç®—çƒä½“æ¯ä¸ªä¸‰è§’é¢å¯¹åº”ä½¿ç”¨å“ªä¸€å¼ å›¾ç‰‡ä½œä¸ºçº¹ç†
  * å…¨æ™¯å›¾è¢«åˆ†æˆ 4*8 å¼ å›¾ç‰‡ ä¹Ÿå°±æ˜¯4è¡Œ8åˆ—
  * çƒä½“çš„ä¸‰è§’é¢æ•°é‡ä¸º æ¨ªå‘åˆ†å‰²æ•°*2 + (çºµå‘åˆ†å‰²æ•°-2)*æ¨ªå‘åˆ†å‰²æ•°*2
  * å¦‚æœçƒä½“çš„çºµå‘åˆ†å‰²å’Œæ¨ªå‘åˆ†å‰²æ­£å¥½æ˜¯4å’Œ8ï¼Œé‚£ä¹ˆé¡¶éƒ¨å’Œåº•éƒ¨çš„æ¯ä¸ªä¸‰è§’é¢å¯¹åº”ä¸€å¼ å›¾ç‰‡ï¼Œä¸­é—´æ¯ä¸¤ä¸ªç›¸é‚»çš„ä¸‰è§’é¢å…±ç”¨ä¸€å¼ å›¾ç‰‡
  * çƒä½“çš„çºµå‘åˆ†å‰²å’Œæ¨ªå‘åˆ†å‰²å¤§äº4å’Œ8ï¼Œé‚£ä¹ˆå¿…é¡»æ˜¯4å’Œ8çš„æ•´æ•°å€ï¼Œè¿™æ ·æ¯ä¸ªä¸‰è§’é¢å’Œä»–å·¦å³çš„ä¸‰è§’é¢å’Œä¸Šä¸‹çš„ä¸‰è§’é¢å…±ç”¨ä¸€å¼ å›¾ç‰‡
  * @param {any} i ä¸‰è§’é¢çš„ç´¢å¼•ï¼ˆç¬¬å‡ ä¸ªä¸‰è§’é¢ï¼‰
  * @param {any} widthSegments çƒä½“æ¨ªå‘åˆ‡å‰²æ•°
  * @param {any} heightSegments çƒä½“çºµå‘åˆ‡å‰²æ•°
  * @param {any} widthScale çƒä½“æ¨ªå‘åˆ‡å‰²æ•°/å…¨æ™¯å›¾çš„æ¨ªå‘åˆ‡å‰²æ•°
  * @param {any} heightScale çƒä½“çºµå‘åˆ‡å‰²æ•°/å…¨æ™¯å›¾çš„çºµå‘åˆ‡å‰²æ•°
  * @returns imgIndex å›¾ç‰‡ç´¢å¼•
  */
 transIndex(i, widthSegments, heightSegments, widthScale, heightScale) {
    let row, col, imgIndex;
    // ç¬¬ä¸€è¡Œ
    if(i < widthSegments) {
      row = 1;
      col = i+1;
    }else if(i < 3*widthSegments) {
      // ç¬¬äºŒè¡Œ
      row = parseInt((i+widthSegments)/(2*widthSegments)) + 1;
      col = parseInt((i - (row-1)*widthSegments)/2) + 1;
    }else if(i < widthSegments+2*widthSegments*(heightSegments-2)) {
      row = parseInt((i-widthSegments)/(2*widthSegments)) + 2;
      col = parseInt((i - (row-2) * 2 * widthSegments -widthSegments )/2) + 1;
    }else {
      // æœ€åä¸€è¡Œ
      row = parseInt((i-widthSegments)/(2*widthSegments)) + 2;
      col = parseInt( i - (row-2) * 2*widthSegments -widthSegments ) + 1;
    }
    row = Math.ceil(row/heightScale);
    col = Math.ceil(col/widthScale);
    imgIndex = (col-1) * 4 + row;
    return imgIndex;
  }
```

## å¦‚ä½•å°†ç¢ç‰‡å›¾æ¸²æŸ“åˆ°å®ƒåº”è¯¥å‡ºç°çš„ä½ç½®ä¸Š

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿä¸ºæ¯ä¸€ä¸ªä¸‰è§’é¢æŒ‡å®šä¸åŒçš„ææ–™äº†ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ä½ ä¼šå‘ç°å®ƒä»¬ç»„åˆèµ·æ¥çš„å›¾å½¢å¹¶æ²¡æœ‰åƒæˆ‘ä»¬çš„é¢„æƒ³é‚£æ ·ã€‚è¿™é‡Œæ¶‰åŠåˆ°threejsä¸­uvæ˜ å°„çš„æ¦‚å¿µã€‚

å…³äºuvæ˜ å°„ï¼Œè¿™é‡Œæ¨è[ä¸€ç¯‡æ–‡ç« ](http://www.techbrood.com/zh/news/webgl/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3three_js%E7%BA%B9%E7%90%86%E8%B4%B4%E5%9B%BE%E5%92%8Cuv%E6%98%A0%E5%B0%84.html])ï¼Œè¿™ç¯‡æ–‡ç« é‡Œä»‹ç»äº†ç«‹æ–¹ä½“è´´å›¾ä¸­uvæ˜ å°„çš„å®ç°æ–¹å¼ã€‚å…¶å®ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å°†ä¸€æ•´å¼ å›¾ç‰‡è´´åˆ°çƒé¢çš„æ—¶å€™ï¼Œthreejså·²ç»ä¸ºæˆ‘ä»¬è®¡ç®—å¥½äº†æ¯ä¸€ä¸ªä¸‰è§’é¢uvæ˜ å°„çš„å€¼ï¼Œè®©æ¯ä¸€ä¸ªä¸‰è§’é¢åªæ¸²æŸ“å›¾ç‰‡çš„æŸä¸€éƒ¨åˆ†ï¼Œç„¶åè¿™äº›ä¸‰è§’é¢ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±ç”Ÿæˆäº†å®Œæ•´çš„å›¾ç‰‡ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è™½ç„¶æ”¹å˜äº†æ¯ä¸€ä¸ªä¸‰è§’é¢æ‰€ä½¿ç”¨çš„æ¸²æŸ“ææ–™ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ”¹å˜å®ƒä»¬çš„uvæ˜ å°„åæ ‡ã€‚æ–‡å­—æè¿°å¯èƒ½ä¸å¤Ÿç›´è§‚ï¼Œæˆ‘ä»¬ä»¥ä¸Šé¢çš„çƒé¢ä¸‰è§’é¢ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ç´¢å¼•ä¸º61çš„ä¸‰è§’é¢ï¼Œå®ƒçš„uvæ˜ å°„åæ ‡ä¸º[(6/12, 2/6), (7/12, 2/6), (6/12, 1/6)],å®ƒè´Ÿè´£æ¸²æŸ“ä¸‹å›¾çš„ç»¿è‰²åŒºåŸŸ:

![demo](../../_media/three/test.jpg)

æ ¹æ®transIndexå‡½æ•°ï¼Œæˆ‘ä»¬è®¡ç®—å‡ºå®ƒåº”è¯¥åŠ è½½çš„ç¢ç‰‡å›¾æ˜¯è¿™å¼ ï¼š

![demo](../../_media/three/slice.jpg)

è¿™æ—¶å€™æ ¹æ®åŸæ¥çš„uvæ˜ å°„åæ ‡ï¼Œå®ƒæ¸²æŸ“çš„å°±æ˜¯ä¸‹å›¾ä¸­ç»¿è‰²åŒºåŸŸï¼š

![demo](../../_media/three/slice2.jpg)

æ‰€ä»¥ï¼Œçœ‹åˆ°é—®é¢˜å‡ºåœ¨å“ªé‡Œäº†å§ï¼Œç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯é‡æ–°è®¡ç®—å‡ºæ¯ä¸€ä¸ªä¸‰è§’é¢çš„uvåæ ‡ï¼Œä¸Šé¢è¿™ç§æƒ…å†µæ˜¯æœ€ç®€å•çš„ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬æŠŠçƒä½“çš„æ¨ªçºµå‘åˆ‡å‰²æ•°å’Œæˆ‘ä»¬çš„å…¨æ™¯å›¾ç‰‡çš„æ¨ªçºµå‘åˆ‡å‰²æ•°è®¾æˆä¸€æ ·ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¯¹äºé¡¶éƒ¨å’Œåº•éƒ¨ï¼Œæ¯ä¸€ä¸ªä¸‰è§’é¢å¯¹åº”æ¯ä¸€ä¸ªç¢ç‰‡å›¾ï¼Œä¸­é—´çš„éƒ¨åˆ†æ¯ä¸¤ä¸ªä¸‰è§’é¢å…±ç”¨ä¸€ä¸ªç¢ç‰‡å›¾ï¼Œä»–ä»¬çš„uvåæ ‡æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“è®¡ç®—å‡ºï¼Œä½†æ˜¯è¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œé¡¶éƒ¨å’Œåº•éƒ¨ç”±äºåªèƒ½åˆ©ç”¨ç¢ç‰‡å›¾çš„ä¸€åŠï¼Œå¿…ç„¶ä¼šå‡ºç°å›¾ç‰‡ä¿¡æ¯çš„ä¸¢å¤±ï¼Œä¸ºäº†è®©ä¸¢å¤±çš„ä¿¡æ¯å°½å¯èƒ½å°‘ï¼Œæˆ‘ä»¬éœ€è¦å°†å›¾ç‰‡åˆ‡å‰²æˆå¾ˆå¤šä»½ï¼Œæˆ‘ä¸ªäººæµ‹è¯•ï¼Œå½“æ¨ªå‘å’Œçºµå‘åˆ‡å‰²æ•°éƒ½>=64çš„æ—¶å€™ï¼Œä¸¢å¤±çš„ä¿¡æ¯æ¥è¿‘äº0ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ‡å‰²å‡º64*64å¼ ç¢ç‰‡å›¾ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæœ‰å¤šè¡Œï¼Œå¤šåˆ—ä¸‰è§’é¢å…±ç”¨ä¸€å¼ ç¢ç‰‡å›¾ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯è®¡ç®—å‡ºå¯¹äºè¿™ä¸€å¼ ç¢ç‰‡å›¾ï¼Œæ¯ä¸€ä¸ªä¸‰è§’é¢çš„uvåæ ‡ï¼Œä¸‹é¢æ˜¯æˆ‘å†™çš„getVertexUvså‡½æ•°(å½“æ—¶å†™çš„æ—¶å€™å¯èƒ½åªæœ‰æˆ‘å’Œä¸Šå¸çŸ¥é“è¿™æ®µä»£ç æ˜¯ä»€ä¹ˆæ„æ€ï¼Œç°åœ¨æ¥çœ‹ï¼Œä¼°è®¡åªæœ‰ä¸Šå¸çŸ¥é“äº†ğŸ˜‚)ï¼š

```js
 /**
  * @description è¿™ä¸ªå‡½æ•°ç”¨æ¥è®¡ç®—å½“å‰ä¸‰è§’é¢å’Œä»–ä¸‹ä¸€ä¸ªä¸‰è§’é¢çš„uvæ˜ å°„åæ ‡ï¼ˆä¸¤ä¸ªç›¸é‚»çš„ä¸‰è§’é¢æ‹¼æˆä¸€ä¸ªçŸ©å½¢ï¼‰
  * æ¯”å¦‚è¯´å½“å‰å…¨æ™¯å›¾æ˜¯4*8 4è¡Œ8åˆ—ï¼Œä½†æ˜¯çƒä½“è¢«åˆ†å‰²æˆ8*16
  * æ‰€ä»¥æŸä¸€å¼ åˆ†å‰²å›¾è¦è¢«å½“å‰è¡Œ4ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸ŠåŠéƒ¨åˆ†ï¼Œè¢«ä¸‹ä¸€è¡Œçš„4ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸‹åŠéƒ¨åˆ†(ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œé™¤å¤–)
  * ç¬¬ä¸€è¡Œçš„è¯å°±æ˜¯2ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸ŠåŠéƒ¨åˆ†ï¼Œä¸‹ä¸€è¡Œçš„4ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸‹åŠéƒ¨åˆ†
  * æœ€åä¸€è¡Œçš„è¯å°±æ˜¯ä¸Šä¸€è¡Œçš„4ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸ŠåŠéƒ¨åˆ†ï¼Œå½“å‰è¡Œçš„2ä¸ªä¸‰è§’é¢ä½¿ç”¨ä¸‹åŠéƒ¨åˆ†
  * æ‰€ä»¥ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œä¼šæœ‰ç¼ºå¤±
  * @param {any} index ç¬¬å‡ ä¸ªä½¿ç”¨å½“å‰å›¾å½¢ä½œä¸ºçº¹ç†çš„ä¸‰è§’é¢
  * @param {any} widthScale çƒä½“æ¨ªå‘åˆ†å‰²/å…¨æ™¯å›¾æ¨ªå‘åˆ‡å‰²
  * @param {any} heightScale çƒä½“çºµå‘åˆ‡å‰²/å…¨æ™¯å›¾çºµå‘åˆ‡å‰²
  * @returns ä¸¤ä¸ªä¸‰è§’é¢çš„uvæ˜ å°„åæ ‡
  */
 getVertexUvs(index, widthScale, heightScale) {
    // ä¸¤ä¸ªä¸‰è§’é¢ç»„æˆçš„çŸ©å½¢çš„å››ä¸ªé¡¶ç‚¹åæ ‡
    const vectors = [
      [((index-1)%widthScale + 1)/widthScale, 1- (parseInt((index-1)/widthScale)%heightScale)/heightScale],
      [((index-1)%widthScale)/widthScale, 1- (parseInt((index-1)/widthScale)%heightScale)/heightScale],
      [((index-1)%widthScale)/widthScale, 1- (parseInt((index-1)/widthScale)%heightScale + 1)/heightScale],
      [((index-1)%widthScale + 1)/widthScale, 1- (parseInt((index-1)/widthScale)%heightScale + 1)/heightScale]
    ];
    return [
      {
        a: vectors[0],
        b: vectors[1],
        c: vectors[3]
      },
      {
        a: vectors[1],
        b: vectors[2],
        c: vectors[3]
      }
    ];
  }
```

æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸€ä¸‹è¿™é‡Œçš„é€»è¾‘ï¼Œè¿™é‡Œä¸å†è¿‡å¤šä»‹ç»ã€‚

## å¦‚ä½•åˆ¤æ–­å½“å‰è§†é‡å†…åº”è¯¥åŠ è½½å“ªäº›ç¢ç‰‡å›¾

æœ€åå›åˆ°ä¸€å¼€å§‹çš„isInSightå‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥åˆ¤æ–­å½“å‰è§†é‡åº”è¯¥åŠ è½½å“ªå¼ ç¢ç‰‡å›¾ã€‚å…ˆè¯´ä¸€ä¸‹å®ç°çš„å¤§æ¦‚æ€è·¯ï¼š

é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰è§†é‡å†…æœ‰å“ªå‡ å¼ ç¢ç‰‡å›¾ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»çš„è§†é”¥ä½“å—ï¼Ÿæ—¢ç„¶è¿™é‡Œå’Œæˆ‘ä»¬çš„è§†é‡æœ‰å…³ï¼Œå½“ç„¶ç¦»ä¸å¼€è§†é”¥ä½“äº†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé—®é¢˜è½¬æ¢ä¸ºå“ªäº›ç¢ç‰‡å›¾ä¸å½“å‰è§†é”¥ä½“ç›¸äº¤ï¼Œå¦‚æœç›¸äº¤ï¼Œé‚£ä¹ˆè¿™å¼ ç¢ç‰‡å›¾å°±åœ¨è§†é‡ä¸­ã€‚

å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç¢ç‰‡å›¾æ˜¯å¦å’Œè§†é”¥ä½“ç›¸äº¤å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸€å¼ ç¢ç‰‡å›¾éƒ½æœ‰è‡ªå·±çš„2dåæ ‡ï¼Œå½“å®ƒè¢«æ¸²æŸ“åˆ°çƒé¢ä¸Šçš„æ—¶å€™ï¼Œä¹Ÿæœ‰è‡ªå·±çš„3dåæ ‡ï¼Œä»2dåæ ‡è½¬æ¢åˆ°3dåæ ‡ï¼Œæœ‰æ²¡æœ‰è®©ä½ æƒ³èµ·ç»çº¬åº¦å‘¢ï¼Ÿè¿˜æ˜¯æ‹¿è¿™å¼ å›¾ç‰‡ä¸ºä¾‹ï¼š

![demo](../../_media/three/lglt.jpg)

å›¾ä¸­ç»¿è‰²çš„ç¢ç‰‡å›¾çš„2dåæ ‡æ˜¯[(3/8, 1/4), (4/8, 1/4), (4/8, 1/2), (3/8, 1/2)]ï¼Œæ¸²æŸ“åˆ°çƒé¢ä¸Šå®ƒçš„ç»åº¦å°±æ˜¯æ¯ä¸ªç‚¹xä¹˜2Ï€ï¼Œçº¬åº¦å°±æ˜¯æ¯ä¸ªç‚¹çš„yåæ ‡ä¹˜Ï€ï¼Œé€šè¿‡çƒä½“çš„é¡¶ç‚¹è®¡ç®—å…¬å¼ï¼Œæˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç¢ç‰‡å›¾çš„å››ä¸ªç‚¹çš„åæ ‡ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªåŒ…å›´çƒï¼Œåˆ¤æ–­åŒ…å›´çƒä¸è§†é”¥ä½“æ˜¯å¦ç›¸äº¤ã€‚

ä¸‹é¢æ˜¯å®Œæ•´å®ç°ï¼š

```js
 /**
  * @description è¿™ä¸ªå‡½æ•°ç”¨æ¥åˆ¤æ–­ä¸€å¼ åˆ‡å›¾æ˜¯ä¸æ˜¯åœ¨å½“å‰è§†çº¿ä¸­
  * çƒä½“é¡¶ç‚¹è®¡ç®—å…¬å¼ x: r*sinÎ¸*cosÏ† y: r*cosÎ¸ z: r*sinÎ¸*sinÏ† Î¸çº¬åº¦ Ï†ç»åº¦
  * è¡Œ => çº¬åº¦  åˆ— => ç»åº¦
  * å…¨æ™¯å›¾ä¸€å…±4è¡Œ8åˆ— é‚£ä¹ˆæŸä¸€å¼ å›¾ç‰‡å¯¹åº”åˆ°çƒé¢ä¸Šçš„é¡¶ç‚¹åæ ‡å°±å¯ä»¥æ±‚å‡ºæ¥
  * ç„¶åæ ¹æ®è¿™4ä¸ªé¡¶ç‚¹åˆ›å»ºä¸€ä¸ªå‡ ä½•å›¾å½¢ï¼Œåˆ¤æ–­è¿™ä¸ªå‡ ä½•å›¾å½¢çš„åŒ…å›´çƒæ˜¯å¦ä¸ç›¸æœºçš„è§†é”¥ä½“ç›¸äº¤
  * @param {any} row å½“å‰åˆ‡å›¾çš„è¡Œ
  * @param {any} col å½“å‰åˆ‡å›¾çš„åˆ—
  * @param {any} camera åˆ¤æ–­ç›¸äº¤çš„ç›¸æœº
  * @returns æ˜¯å¦åœ¨å½“å‰è§†çº¿
  */
 isInSight(row, col, camera) {
    // çƒä½“åŠå¾„
    const Radius = 10;
    // ç»åº¦ 2Ï€ åˆ†æˆ8ä»½ï¼Œ æ¯ä»½æ˜¯4/Ï€
    // ç»´åº¦ Ï€ åˆ†æˆ4ä»½ï¼Œ æ¯ä»½ä¹Ÿæ˜¯4/Ï€
    const ltPoint = {
      x: Radius*Math.sin(col * Math.PI / 4) * Math.cos(row * Math.PI / 4),
      y: Radius*Math.cos(col * Math.PI / 4),
      z: Radius*Math.sin(col * Math.PI / 4) * Math.sin(row * Math.PI / 4)
    };
    const rtPoint = {
      x: Radius*Math.sin(col * Math.PI / 4) * Math.cos((row+1) * Math.PI / 4),
      y: Radius*Math.cos(col * Math.PI / 4),
      z: Radius*Math.sin(col * Math.PI / 4) * Math.sin((row+1) * Math.PI / 4)
    };
    const lbPoint = {
      x: Radius*Math.sin((col+1) * Math.PI / 4) * Math.cos(row * Math.PI / 4),
      y: Radius*Math.cos((col+1) * Math.PI / 4),
      z: Radius*Math.sin((col+1) * Math.PI / 4) * Math.sin(row * Math.PI / 4)
    };
    const rbPoint = {
      x: Radius*Math.sin((col+1) * Math.PI / 4) * Math.cos((row+1) * Math.PI / 4),
      y: Radius*Math.cos((col+1) * Math.PI / 4),
      z: Radius*Math.sin((col+1) * Math.PI / 4) * Math.sin((row+1) * Math.PI / 4)
    };

    // åˆ›å»ºä¸€ä¸ªå‡ ä½•å›¾å½¢ï¼Œå››ä¸ªé¡¶ç‚¹åˆ†åˆ«ä¸ºè´´å›¾çš„å››ä¸ªé¡¶ç‚¹åæ ‡ã€
    const geometry = new Geometry();
    geometry.vertices.push(
        new Vector3( ltPoint.x, ltPoint.y, ltPoint.z ),
        new Vector3( rtPoint.x, rtPoint.y, rtPoint.z ),
        new Vector3( lbPoint.x, lbPoint.y, lbPoint.z ),
        new Vector3( rbPoint.x, rbPoint.y, rbPoint.z ),
    );
    geometry.faces.push( new Face3( 0, 1, 2 ), new Face3( 1, 2, 3 ) );

    // ç„¶ååˆ¤æ–­åŒ…å›´çƒæ˜¯å¦ä¸è§†é”¥ä½“ç›¸äº¤
    const tagMesh = new Mesh(geometry);
    const off = this.isOffScreen(tagMesh, camera);
    return !off;
  }
```

## æœ€å

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†å…¨æ™¯å›¾çš„æŒ‰éœ€åŠ è½½ï¼Œé¡¹ç›®ä¸­å‰©ä¸‹çš„vrçœ¼é•œæ¨¡å¼ï¼Œé™¤css3dçš„å…¼å®¹å®ç°ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä½¿ç”¨threejsçš„ç›¸å…³æ’ä»¶å®Œæˆçš„ï¼Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»[é¡¹ç›®åœ°å€](https://github.com/fightingm/vrpano)ä¸­æŸ¥çœ‹ï¼Œæœ‰é—®é¢˜æ¬¢è¿äº¤æµï¼Œå¦‚æœè¯¥é¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œåˆ«å¿˜äº†ç»™ä¸ªstarå“¦ï¼Œæ„Ÿè°¢é˜…è¯»ã€‚